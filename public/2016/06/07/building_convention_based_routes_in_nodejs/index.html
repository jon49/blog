<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Building a Convention Based Routes in Node.js</title>
  <meta name="description" content="">
  <meta name="author" content="Jon Nyman">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>@import url("//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css");
body{background-color:#c2dfff;font-family:sans-serif;color:#36465d;}body > *{margin:0 auto;width:100%}a{color:#86555c;}a:visited{color:#36465d}nav,.archive,.footer-menu,.nav-posts{text-align:center;font-size:16px;line-height:24px;}nav ul,.archive ul,.footer-menu ul,.nav-posts ul{padding:0}nav li,.archive li,.footer-menu li,.nav-posts li{list-style-type:none}nav a,.archive a,.footer-menu a,.nav-posts a{text-decoration:none;color:#36465d;padding:15px}nav a:hover,.archive a:hover,.footer-menu a:hover,.nav-posts a:hover{color:#c2dfff;background-color:#83a4d2}.posts a{padding-top:3px;padding-bottom:3px;display:block}.nav-posts{margin-top:15px;font-weight:bold;}.nav-posts .next::before{content:'«'}.nav-posts .previous::after{content:' »'}.nav-posts a{text-decoration:none}nav li,.footer-menu li{display:inline-block}h1{border-bottom:solid #36465d 1px;padding:10px;font-size:32px}footer{font-size:12px;text-align:center}@media screen and (min-width:801px){body > *{width:800px}}header{text-align:center}header *{color:#86555c}.header-logo{display:inline-block}.header-logo > *{font-size:32px;position:relative;float:left}.hider{overflow:hidden}#t-com{animation-name:slideInRight;animation-iteration-count:1;animation-duration:3s;animation-fill-mode:forwards}#t-on,#t-space{left:0;animation-name:slideOutLeft;animation-iteration-count:1;animation-duration:5s;animation-delay:1.5s;animation-fill-mode:forwards}.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.hljs-name,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo{color:#86555c}.hljs-number,.hljs-preprocessor,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant{color:#987f5a}.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute{color:#a49a59}.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.ruby .hljs-symbol,.xml .hljs-cdata{color:#7d9726}.hljs-title,.css .hljs-hexcolor{color:#5b9d48}.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title{color:#83a4d2}.hljs-keyword,.javascript .hljs-function{color:#5f9182}.diff .hljs-deletion,.diff .hljs-addition{color:#22221b;display:inline-block;width:100%}.diff .hljs-deletion{background-color:#ba6236}.diff .hljs-addition{background-color:#7d9726}.diff .hljs-change{color:#36a166}.hljs{display:block;overflow-x:auto;background:#36465d;color:#c2dfff;padding:.5em;-webkit-text-size-adjust:none}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata{opacity:.5}@-moz-keyframes slideInRight{0%{transform:translateX(100%)}100%{transform:translateX(0)}}@-webkit-keyframes slideInRight{0%{transform:translateX(100%)}100%{transform:translateX(0)}}@-o-keyframes slideInRight{0%{transform:translateX(100%)}100%{transform:translateX(0)}}@keyframes slideInRight{0%{transform:translateX(100%)}100%{transform:translateX(0)}}@-moz-keyframes slideOutLeft{0%{margin-left:0}100%{margin-left:-268px}}@-webkit-keyframes slideOutLeft{0%{margin-left:0}100%{margin-left:-268px}}@-o-keyframes slideOutLeft{0%{margin-left:0}100%{margin-left:-268px}}@keyframes slideOutLeft{0%{margin-left:0}100%{margin-left:-268px}}</style>
</head>
<body>

<nav>
  <ul>
    <li>
      <a href="/">Archive</a>
    </li>
    <li>
      <a href="/about/">About</a>
    </li>
  </ul>
</nav>

<header>
  <a href="/" class="header-logo">
      <div id="t-j">J</div>
      <div class="hider">
          <div id="t-on">on</div>
      </div>
      <div id="t-space">&nbsp;</div>
      <div id="t-nyman">Nyman</div>
      <div class="hider">
          <div id="t-com">.com</div>
      </div>
  </a>
</header>


<h1>Building a Convention Based Routes in Node.js</h1>
<article>
  <blockquote>
<p><a href="https://en.wikipedia.org/wiki/Convention_over_configuration">Convention over
configuration</a>
(also known as coding by convention) is a software design paradigm which
seeks to decrease the number of decisions that developers need to make,
gaining simplicity, and not necessarily losing flexibility.</p>
</blockquote>

<p>It seems in programming, if we haven&rsquo;t learned the basic practices of others,
we&rsquo;ll end of repeating those practices; discovering them on our own. This isn&rsquo;t
necessarily a bad thing. It can be a good way to learn. But at the same time,
we can learn faster just by learning from others first. I also like to think
about how a pattern or architecture could come about.</p>

<p>Take for example the library <a href="http://intercoolerjs.org/">intercooler.js</a>. You
can see where that library originated from. In HTML you can call a function
directly by adding an event to it. E.g.,</p>

<pre><code class="language-js">&lt;div onclick=&quot;clicked(this, 'my string I am passing')&quot;&gt;Click Me!&lt;/div&gt;
</code></pre>

<p>So, intercooler.js took it the next step. They made it so you can create a
declarative HTML syntax. Similar to the code above, but an abstraction of that.
Now, I can see where <a href="https://angularjs.org/">angular.js</a> came from (note, I&rsquo;ve
never actually used angular.js). It just takes another abstraction layer up.</p>

<p>Well, for convention of configuration. I came up with something for node.js,
but, after coming up with the idea I noticed that other people had come up with
similar ideas. In the end I liked mine more than theirs. But, many times we
think we are being original, but many of the ideas have probably existed for
the past thirty plus years.</p>

<p>I went to a class at work where they were showing ASP.NET WebAPI. It is also
convention based and pretty much did the same thing I came up with, but more
powerful. I can understand why people don&rsquo;t like convention over configuration
since you need to learn the conventions before you can understand the code,
since there is a certain amount of &ldquo;magic&rdquo;. But once you get past the magic it
becomes nice since you don&rsquo;t need to write the same code over and over again.</p>

<p>So, after that long introduction, here&rsquo;s how I did convention based node.js.</p>

<p>The file structure is like so:</p>

<pre><code>root
  ┕ controllers
    ┝ people
    │ ┝ get-{id}.js
    │ ┕ get-{id}-animals.js
    ┕ animals
      ┝ get-{id}.js
      ┕ delete-{id}.js
</code></pre>

<p>These directories/files would correspond to the routes:</p>

<pre><code>/api/people/{id} → Method: GET
/api/people/{id} → Method: GET
/api/animals/{id} → Method: GET
/api/animals/{id} → Method: DELETE
</code></pre>

<p>As you can see you could set up whatever combination you would like. I like
this method of convention also, since it keeps things simple. All your routes
are in your controller and easy to scan. So, when I need to edit a file I can
quickly find which one I&rsquo;m looking for. Some of the other libraries nest the
routes in directories, which becomes very tedious.</p>

<p>I use <a href="http://swagger.io/">swagger</a> to map the route definitions to the route
methods. This way, I must have documentation in order to have a route. No
documentation, no route. But it also leaves me the flexibility to create routes
outside of this documentation if I really need to. But it just means it won&rsquo;t
be set up in the normal way.</p>

<p>So, in swagger (using YAML), the code would look like so:</p>

<pre><code class="language-yaml">paths:

    /api/people/{id}:
      get:
        _call:
          - [params, id]

    /api/animals/{id}:
      delete:
        _call:
          - [params, id]
</code></pre>

<p>So, you can see how you can pass pretty much anything into your route method.
Each array element is passed into the method in the order given. The call takes
the parameters from the <code>request</code> object that <code>express.js</code> passes in. For more
complex items you can even pass in an object from different parts of the
<code>request</code> object like so:</p>

<pre><code class="language-yaml">_call:
  - userId: [params, id]
    userName: [user, username]
    guid: [user, guid]
</code></pre>

<p>Where <code>user</code> comes from some middleware which validates the user authentication
information.</p>

<p>This way of doing things also comes in handy since it means I can automate
integration tests. I can test each route in the <code>swagger</code> file and make sure
that it is validated against the json-schema associated with that route.</p>

<p>So, let&rsquo;s look at the glue for all of this. I didn&rsquo;t create an npm library for
this. I was thinking I would eventually, but since I just use WebAPI now, I
don&rsquo;t want to support it. But, luckily the code is simple enough that that
isn&rsquo;t a problem!</p>

<pre><code class="language-ts">import path = require('path')

module SwaggerRoutes {
    export interface Options {
        swagger: any
        baseRoute: any
        response: any
        baseDirectory: string
    }
    export interface CreateRoutes {
        (options: Options): void
    }
}

const
fail = reason =&gt; {throw new Error(reason)},
type = o =&gt; Object.prototype.toString.call(o),
isFunction = o =&gt; type(o) === '[object Function]',
isArray = o =&gt; type(o) === '[object Array]',
isObject = o =&gt; type(o) === '[object Object]',
getPropValue = (path, obj) =&gt;
    path.reduce((acc, prop) =&gt; acc === void 0 ? void 0 : acc[prop], obj),
args = (o, xs) =&gt;
    xs.map(x =&gt; (
        isArray(x)
            ? getPropValue(x, o)
        : isObject(x)
            ? (Object
                .keys(x)
                .reduce((acc, name) =&gt;
                    (acc[name] = getPropValue(x[name], o), acc), {}))
        : void 0
    ))

const routePath = (route: string) =&gt; {
    const
    components = route.slice(1).split('/'),
    dir = components[0],
    baseFileName = components.slice(1).join('-')
    return [dir, baseFileName]
}

const expressCallback = (response, routeProperties, method, controller) =&gt;
    (request, client, error) =&gt; {

        const send = &lt;any&gt; response.bind(response, client)
        controller.apply(controller, args(request, routeProperties[method]._call))
        .then(send)
        .catch(error)

    }

const createRoutes: SwaggerRoutes.CreateRoutes = (o: SwaggerRoutes.Options) =&gt; {
    const paths = o.swagger.paths
    Object.keys(paths)
    .filter(x =&gt; x.charAt(0) === '/')
    .forEach(routeName =&gt; {

        const
        routeProperties = paths[routeName],
        basePath = routePath(routeName)

        Object.keys(routeProperties)
        .forEach(method =&gt; {
            if (routeProperties[method]._call) {
                const
                requirePath = path.resolve(
                    __dirname,
                    path.join(
                        o.baseDirectory,
                        basePath[0],
                        (basePath[1] ? `${method}-${basePath[1]}` : method))),
                handler = require(requirePath),
                controller =
                    isFunction(handler)
                        ? handler
                    : isFunction(handler.default)
                        ? handler.default
                    : fail('Could not retrieve `handler` function.')

                const
                routePath = routeName.replace(/{(\w+)}/g, ':$1'),
                altPath =
                    (routeProperties[method].parameters || [])
                    .reduce((acc, x) =&gt;
                        x.required ? acc : acc.replace(RegExp(`/:${x.name}`), ''), routePath),
                routePaths = altPath !== routePath ? [altPath, routePath] : [routePath]

                routePaths.forEach(x =&gt; {
                    o.baseRoute(x)
                    [method](expressCallback(o.response, routeProperties, method, controller))
                })

            }
        })

    })
}

export = createRoutes
</code></pre>

<p>Here&rsquo;s how you would call that code to set up your routes:</p>

<pre><code class="language-ts">import swaggerRoutes = require('./swagger-routes')
const yaml = require('js-yaml')

swaggerRoutes({
    swagger: yaml.load(readFileSync('./api/api.yml', 'utf-8')),
    baseRoute: authenticatedRoute,
    response: (client: express.Response, result) =&gt;
        client.send(omit(['httpStatusCode'], withMessageAs(result))),
    baseDirectory: '../controllers'
})
</code></pre>

</article>
<p>

    <span>Tue Jun 7, 2016</span>

   | 

  
    tags:
      <a href="/tags/node.js">node.js</a>
    
      <a href="/tags/convention-over-configuration">convention over configuration</a>
    
  

  

  

</p>


<div class="nav-posts">
  
    <a class="next" href="http://jnyman.com/2014/12/30/css_media_object/"> CSS Media Object</a>
  

  
    
      
      ✴
      
      <a class="previous" href="http://jnyman.com/2016/06/13/lambda_expressions_in_javascript/"> On-the-Fly Lambda Expressions in JavaScript</a>
    
  
</div>


<div class="footer-menu">
  <ul>

    <li>
      <a class=" fa fa-rss fa-2x" href="/index.xml" title="RSS Feed"></a>
    </li>

    <li>
      <a class=" fa fa-github fa-2x" href="https://github.com/jon49/" title="Personal Github Account"></a>
    </li>

    <li>
      <a class=" fa fa-twitter fa-2x" href="https://twitter.com/NymanJon" title="Personal Twitter Account"></a>
    </li>

  </ul>
</div>

<footer>
  <p>
  © 2016 Jon Nyman
    <br>
    nymanjon@gmail.com
    <br>
    Hamsters Byte
  </p>
</footer>

</body>
</html>


<script src="/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
