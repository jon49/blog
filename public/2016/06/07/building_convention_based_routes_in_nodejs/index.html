<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Building a Convention Based Routes in Node.js</title>
  <meta property="og:title" content="Building a Convention Based Routes in Node.js" />
  <meta name="twitter:title" content="Building a Convention Based Routes in Node.js" />
  <meta name="description" content="Convention over configuration (also known as coding by convention) is a software design paradigm which seeks to decrease the number of decisions that developers need to make, gaining simplicity, and not necessarily losing flexibility.
 It seems in programming, if we haven&rsquo;t learned the basic practices of others, we&rsquo;ll end of repeating those practices; discovering them on our own. This isn&rsquo;t necessarily a bad thing. It can be a good way to learn.">
  <meta property="og:description" content="Convention over configuration (also known as coding by convention) is a software design paradigm which seeks to decrease the number of decisions that developers need to make, gaining simplicity, and not necessarily losing flexibility.
 It seems in programming, if we haven&rsquo;t learned the basic practices of others, we&rsquo;ll end of repeating those practices; discovering them on our own. This isn&rsquo;t necessarily a bad thing. It can be a good way to learn.">
  <meta name="twitter:description" content="Convention over configuration (also known as coding by convention) is a software design paradigm which seeks to decrease the number of decisions that developers need to make, gaining simplicity, and …">
  <meta name="author" content="Jon Nyman"/>
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@NymanJon" />
  <meta name="twitter:creator" content="@NymanJon" />
  <meta property="og:url" content="http://jnyman.com/2016/06/07/building_convention_based_routes_in_nodejs/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="JNyman.com" />

  <meta name="generator" content="Hugo 0.25.1" />
  <link rel="canonical" href="http://jnyman.com/2016/06/07/building_convention_based_routes_in_nodejs/" />
  <link rel="alternate" href="http://jnyman.com/index.xml" type="application/rss+xml" title="JNyman.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="http://jnyman.com/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://jnyman.com/css/pygment_highlights.css" />
  <link rel="stylesheet" href="http://jnyman.com/css/highlight.min.css" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://jnyman.com/">JNyman.com</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags/">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Building a Convention Based Routes in Node.js</h1>
                
                
                  <span class="post-meta">
  Posted on June 7, 2016
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <blockquote>
<p><a href="https://en.wikipedia.org/wiki/Convention_over_configuration">Convention over
configuration</a>
(also known as coding by convention) is a software design paradigm which
seeks to decrease the number of decisions that developers need to make,
gaining simplicity, and not necessarily losing flexibility.</p>
</blockquote>

<p>It seems in programming, if we haven&rsquo;t learned the basic practices of others,
we&rsquo;ll end of repeating those practices; discovering them on our own. This isn&rsquo;t
necessarily a bad thing. It can be a good way to learn. But at the same time,
we can learn faster just by learning from others first. I also like to think
about how a pattern or architecture could come about.</p>

<p>Take for example the library <a href="http://intercoolerjs.org/">intercooler.js</a>. You
can see where that library originated from. In HTML you can call a function
directly by adding an event to it. E.g.,</p>

<pre><code class="language-js">&lt;div onclick=&quot;clicked(this, 'my string I am passing')&quot;&gt;Click Me!&lt;/div&gt;
</code></pre>

<p>So, intercooler.js took it the next step. They made it so you can create a
declarative HTML syntax. Similar to the code above, but an abstraction of that.
Now, I can see where <a href="https://angularjs.org/">angular.js</a> came from (note, I&rsquo;ve
never actually used angular.js). It just takes another abstraction layer up.</p>

<p>Well, for convention of configuration. I came up with something for node.js,
but, after coming up with the idea I noticed that other people had come up with
similar ideas. In the end I liked mine more than theirs. But, many times we
think we are being original, but many of the ideas have probably existed for
the past thirty plus years.</p>

<p>I went to a class at work where they were showing ASP.NET WebAPI. It is also
convention based and pretty much did the same thing I came up with, but more
powerful. I can understand why people don&rsquo;t like convention over configuration
since you need to learn the conventions before you can understand the code,
since there is a certain amount of &ldquo;magic&rdquo;. But once you get past the magic it
becomes nice since you don&rsquo;t need to write the same code over and over again.</p>

<p>So, after that long introduction, here&rsquo;s how I did convention based node.js.</p>

<p>The file structure is like so:</p>

<pre><code>root
  â”• controllers
    â” people
    â”‚ â” get-{id}.js
    â”‚ â”• get-{id}-animals.js
    â”• animals
      â” get-{id}.js
      â”• delete-{id}.js
</code></pre>

<p>These directories/files would correspond to the routes:</p>

<pre><code>/api/people/{id} â†’ Method: GET
/api/people/{id} â†’ Method: GET
/api/animals/{id} â†’ Method: GET
/api/animals/{id} â†’ Method: DELETE
</code></pre>

<p>As you can see you could set up whatever combination you would like. I like
this method of convention also, since it keeps things simple. All your routes
are in your controller and easy to scan. So, when I need to edit a file I can
quickly find which one I&rsquo;m looking for. Some of the other libraries nest the
routes in directories, which becomes very tedious.</p>

<p>I use <a href="http://swagger.io/">swagger</a> to map the route definitions to the route
methods. This way, I must have documentation in order to have a route. No
documentation, no route. But it also leaves me the flexibility to create routes
outside of this documentation if I really need to. But it just means it won&rsquo;t
be set up in the normal way.</p>

<p>So, in swagger (using YAML), the code would look like so:</p>

<pre><code class="language-yaml">paths:

    /api/people/{id}:
      get:
        _call:
          - [params, id]

    /api/animals/{id}:
      delete:
        _call:
          - [params, id]
</code></pre>

<p>So, you can see how you can pass pretty much anything into your route method.
Each array element is passed into the method in the order given. The call takes
the parameters from the <code>request</code> object that <code>express.js</code> passes in. For more
complex items you can even pass in an object from different parts of the
<code>request</code> object like so:</p>

<pre><code class="language-yaml">_call:
  - userId: [params, id]
    userName: [user, username]
    guid: [user, guid]
</code></pre>

<p>Where <code>user</code> comes from some middleware which validates the user authentication
information.</p>

<p>This way of doing things also comes in handy since it means I can automate
integration tests. I can test each route in the <code>swagger</code> file and make sure
that it is validated against the json-schema associated with that route.</p>

<p>So, let&rsquo;s look at the glue for all of this. I didn&rsquo;t create an npm library for
this. I was thinking I would eventually, but since I just use WebAPI now, I
don&rsquo;t want to support it. But, luckily the code is simple enough that that
isn&rsquo;t a problem!</p>

<pre><code class="language-ts">import path = require('path')

module SwaggerRoutes {
    export interface Options {
        swagger: any
        baseRoute: any
        response: any
        baseDirectory: string
    }
    export interface CreateRoutes {
        (options: Options): void
    }
}

const
fail = reason =&gt; {throw new Error(reason)},
type = o =&gt; Object.prototype.toString.call(o),
isFunction = o =&gt; type(o) === '[object Function]',
isArray = o =&gt; type(o) === '[object Array]',
isObject = o =&gt; type(o) === '[object Object]',
getPropValue = (path, obj) =&gt;
    path.reduce((acc, prop) =&gt; acc === void 0 ? void 0 : acc[prop], obj),
args = (o, xs) =&gt;
    xs.map(x =&gt; (
        isArray(x)
            ? getPropValue(x, o)
        : isObject(x)
            ? (Object
                .keys(x)
                .reduce((acc, name) =&gt;
                    (acc[name] = getPropValue(x[name], o), acc), {}))
        : void 0
    ))

const routePath = (route: string) =&gt; {
    const
    components = route.slice(1).split('/'),
    dir = components[0],
    baseFileName = components.slice(1).join('-')
    return [dir, baseFileName]
}

const expressCallback = (response, routeProperties, method, controller) =&gt;
    (request, client, error) =&gt; {

        const send = &lt;any&gt; response.bind(response, client)
        controller.apply(controller, args(request, routeProperties[method]._call))
        .then(send)
        .catch(error)

    }

const createRoutes: SwaggerRoutes.CreateRoutes = (o: SwaggerRoutes.Options) =&gt; {
    const paths = o.swagger.paths
    Object.keys(paths)
    .filter(x =&gt; x.charAt(0) === '/')
    .forEach(routeName =&gt; {

        const
        routeProperties = paths[routeName],
        basePath = routePath(routeName)

        Object.keys(routeProperties)
        .forEach(method =&gt; {
            if (routeProperties[method]._call) {
                const
                requirePath = path.resolve(
                    __dirname,
                    path.join(
                        o.baseDirectory,
                        basePath[0],
                        (basePath[1] ? `${method}-${basePath[1]}` : method))),
                handler = require(requirePath),
                controller =
                    isFunction(handler)
                        ? handler
                    : isFunction(handler.default)
                        ? handler.default
                    : fail('Could not retrieve `handler` function.')

                const
                routePath = routeName.replace(/{(\w+)}/g, ':$1'),
                altPath =
                    (routeProperties[method].parameters || [])
                    .reduce((acc, x) =&gt;
                        x.required ? acc : acc.replace(RegExp(`/:${x.name}`), ''), routePath),
                routePaths = altPath !== routePath ? [altPath, routePath] : [routePath]

                routePaths.forEach(x =&gt; {
                    o.baseRoute(x)
                    [method](expressCallback(o.response, routeProperties, method, controller))
                })

            }
        })

    })
}

export = createRoutes
</code></pre>

<p>Here&rsquo;s how you would call that code to set up your routes:</p>

<pre><code class="language-ts">import swaggerRoutes = require('./swagger-routes')
const yaml = require('js-yaml')

swaggerRoutes({
    swagger: yaml.load(readFileSync('./api/api.yml', 'utf-8')),
    baseRoute: authenticatedRoute,
    response: (client: express.Response, result) =&gt;
        client.send(omit(['httpStatusCode'], withMessageAs(result))),
    baseDirectory: '../controllers'
})
</code></pre>

      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="http://jnyman.com/2014/12/30/css_media_object/" data-toggle="tooltip" data-placement="top" title="CSS Media Object">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="http://jnyman.com/2016/06/13/lambda_expressions_in_javascript/" data-toggle="tooltip" data-placement="top" title="On-the-Fly Lambda Expressions in JavaScript">Next Post &rarr;</a>
          </li>
        
      </ul>

      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/jon49" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/NymanJon" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/eenyman" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          Jon Nyman
          &nbsp;&bull;&nbsp;
          2017

          
            &nbsp;&bull;&nbsp;
            <a href="http://jnyman.com/">JNyman.com</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.25.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="http://jnyman.com/js/main.js"></script>
<script src="http://jnyman.com/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="/js/load-photoswipe.js"></script>



  </body>
</html>

