<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Validation in F#</title>
  <meta property="og:title" content="Validation in F#" />
  <meta name="twitter:title" content="Validation in F#" />
  <meta name="description" content="The full code for this article is up on GitHub.
I like to the keep things as simple as possible and, ideally, reusable. At my previous employment I came up with a method of validation, but I was never entirely happy with the results. Some of the code repeated itself, and it was difficult to extend to arrays and array comparison. So, I went back to the drawing board building on top of the ideas that I created with the first validation library I created.">
  <meta property="og:description" content="The full code for this article is up on GitHub.
I like to the keep things as simple as possible and, ideally, reusable. At my previous employment I came up with a method of validation, but I was never entirely happy with the results. Some of the code repeated itself, and it was difficult to extend to arrays and array comparison. So, I went back to the drawing board building on top of the ideas that I created with the first validation library I created.">
  <meta name="twitter:description" content="The full code for this article is up on GitHub.
I like to the keep things as simple as possible and, ideally, reusable. At my previous employment I came up with a method of validation, but I was never â€¦">
  <meta name="author" content="Jon Nyman"/>
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@NymanJon" />
  <meta name="twitter:creator" content="@NymanJon" />
  <meta property="og:url" content="http://jnyman.com/2016/11/27/validation_in_fsharp/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="JNyman.com" />

  <meta name="generator" content="Hugo 0.25.1" />
  <link rel="canonical" href="http://jnyman.com/2016/11/27/validation_in_fsharp/" />
  <link rel="alternate" href="http://jnyman.com/index.xml" type="application/rss+xml" title="JNyman.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="http://jnyman.com/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://jnyman.com/css/pygment_highlights.css" />
  <link rel="stylesheet" href="http://jnyman.com/css/highlight.min.css" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://jnyman.com/">JNyman.com</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags/">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Validation in F#</h1>
                
                
                  <span class="post-meta">
  Posted on November 27, 2016
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p><a href="https://gist.github.com/jon49/c2835a9c85b43036323547dc3706ebd2">The full code for this article is up on GitHub.</a></p>

<p>I like to the keep things as simple as possible and, ideally, reusable. At my
previous employment I came up with a method of validation, but I was never
entirely happy with the results. Some of the code repeated itself, and it was
difficult to extend to arrays and array comparison. So, I went back to the
drawing board building on top of the ideas that I created with the first
validation library I created.</p>

<p>Here&rsquo;s how the original API looked:</p>

<pre><code class="language-fsharp">validate &quot;Name&quot; a.Name [nonEmptyString]
</code></pre>

<p>So, you needed to add the name of your property, the property, and a list of
validators you would like to validate. The list of validators would return a
<code>Choice&lt;string, 'a&gt;</code>.</p>

<p>The new validation has a pretty straight forward API that is used throughout.
You can validate against an <code>Object</code>, <code>Array</code>, <code>Primitive</code>, or <code>Raw</code> value.</p>

<p>The <code>Object</code> validation validates against each property in a <code>Record</code>. If one
fails then it will continue to validate the other properties also. But if
there are multiple validators on a single property the first failure will
return but not the others. <code>Object</code> has the following signature:</p>

<pre><code class="language-fsharp">| Object of
    value : Expr&lt;'a&gt; *
    required : bool *
    proof : ('a -&gt; (string list option) list)
</code></pre>

<p>Where <code>value</code> is the quotation value of the property you are testing.
<code>required</code> tests if the property is <code>null</code> or not if you mark it as true,
otherwise it doesn&rsquo;t care if it is <code>null</code> or not. <code>proof</code> is the list of
provided validators. A single validator has the signature
<code>a -&gt; string option</code>. If the property is valid the validator returns <code>None</code>
otherwise it returns <code>Some</code> with a message describing why it didn&rsquo;t pass
validation.</p>

<p>I like this way of validating since it keeps things simple. The validators are
reusable functions which return a simple <code>string option</code>. The validators are
composable functions that can be put in a list. The discriminated union
validation object is also composable.</p>

<p>Some things that I don&rsquo;t like about validating this way. There is no compile
time check to determine if you validated each field in an object. For that
matter there is no runtime test for that either. It would be nice to have a
least a runtime way to tell if all properties were tested, or, even better, a
compile time way. But this works for now.</p>

<p>Here&rsquo;s an example of using all the validators in with an object.</p>

<pre><code class="language-fsharp">type Person =
    {
    Name : Name
    BirthDate : DateTime
    Favorites : string[]
    FavoriteNumbers : int[]
    }
    static member Proof a =
                [
                prove &lt;| Primitive (&lt;@ a.BirthDate @&gt;, true, [])
                prove &lt;| Object (&lt;@ a.Name @&gt;, true, Name.Proof)
                prove &lt;|
                    Array (
                        &lt;@ a.Favorites @&gt;,
                        true,
                        [arrayMinLength 1],
                        (fun favorite -&gt; Primitive (&lt;@ favorite @&gt;, true, [stringMax 5]) ))
                prove &lt;|
                    Array (
                        &lt;@ a.FavoriteNumbers @&gt;,
                        true,
                        [arrayMinLength 1],
                        fun favorite -&gt; Primitive (&lt;@ favorite @&gt;, true, [greaterThan 2])
                    )
                prove &lt;|
                    Raw (
                        (a.Favorites, a.FavoriteNumbers),
                        &quot;Person.Favorites, Person.FavoriteNumbers&quot;,
                        [
                        fun (a, b) -&gt;
                            match a, b with
                            | null, null | null, _ | _, null -&gt; Some &quot;Arrays must not be null.&quot;
                            | _ -&gt; None
                        fun (a, b) -&gt;
                            if a.Length = b.Length then
                                None
                            else
                                Some &lt;| sprintf &quot;Arrays must have same length but Person.Favorites has %i and Person.FavoriteNumbers has %i&quot; a.Length b.Length
                        ]
                    )
                ]
    static member Validate a =
        prove &lt;| Object (&lt;@ a @&gt;, true, Person.Proof)

let jon = {
    Name = { First = &quot;Jon&quot;; Last = &quot;Nyman1&quot; }
    BirthDate = new DateTime(1947, 9, 9)
    Favorites = [| &quot;Reading&quot;; &quot;Red&quot;;  &quot;Writing&quot; |]
    FavoriteNumbers = [| 1 |]
    }

jon
|&gt; validate Person.Validate
// |&gt; ....

// OR
jon
|&gt; validate (fun a -&gt; prove &lt;| Object (&lt;@ a @&gt;, true, Person.Proof))

</code></pre>

<p>where <code>prove</code> is</p>

<pre><code class="language-fsharp">let rec prove validation =
    match validation with
    | Primitive (v, required, fs) -&gt;
        match required, getValue v with
        | true, None -&gt; Some [sprintf &quot;The value `%s` is required but was found to be `null`.&quot; v.Type.Name]
        | false, None -&gt; None
        | _, Some value -&gt;
            fs
            |&gt; List.fold (fun acc f -&gt;
                match acc with
                | None -&gt; f value
                | Some _ -&gt; acc
                ) None
            |&gt; Option.map (fun x -&gt; [printParameterWith &quot; - &quot; v + x] )
    | Object (v, required, f) -&gt;
        match required, getValue v with
        | true, None -&gt; Some [sprintf &quot;The object `%s` is required but was found to be `null`.&quot; (getOrElse &quot;Unknown Parameter&quot; &lt;| getParameterName v)]
        | false, None -&gt; None
        | _, Some x -&gt;
            f x
            |&gt; List.fold (
                fun acc option -&gt;
                match option, acc with
                | Some newError, Some error -&gt; Some (List.append error newError)
                | Some newError, None -&gt; Some newError
                | None, Some error -&gt; Some error
                | None, None -&gt; None
                ) None
    | Array (vs, required, proof, proveItems) -&gt; 
        match required, getValue vs with
        | true, None -&gt; Some [sprintf &quot;%s: %s&quot; (getOrElse &quot;Unknown Parameter&quot; &lt;| getParameterName vs) &quot;This array is required.&quot;]
        | false, None -&gt; None
        | _, Some xs -&gt;
            let validSelf =
                proof
                |&gt; List.fold (fun acc f -&gt;
                    match acc with
                    | None -&gt; f xs
                    | Some _ -&gt; acc
                ) None
            match validSelf, obj.Equals(vs, null) with
            | Some error, _ -&gt; 
                Some [(printParameterWith &quot;: &quot; vs) + error]
            | _, true -&gt;
                None
            | None, false -&gt;
                xs
                |&gt; Array.fold (fun (i, acc) x -&gt;
                    let i = i + 1
                    match (prove (proveItems x) ), acc with
                    | Some newError, Some error -&gt; 
                        (i, Some &lt;| List.append error [prettyIndex i newError])
                    | Some newError, None -&gt; (i, Some [prettyIndex i newError])
                    | None, Some error -&gt; (i, Some error)
                    | None, None -&gt; (i, None)
                ) (-1, None)
                |&gt; snd
                |&gt; Option.map (fun xs -&gt; (printParameterWith &quot;:&quot; vs)::xs)
    | Raw (a, msg, fs) -&gt;
        fs
        |&gt; List.fold (fun acc f -&gt;
            match acc with
            | None -&gt; f a
            | Some _ -&gt; acc
            ) None
        |&gt; Option.map (fun x -&gt; [msg+&quot; - &quot;+x] )
</code></pre>

<p>And <code>validate</code> is:</p>

<pre><code class="language-fsharp">let validate f a =
    match f a with
    | Some xs -&gt; Choice1Of2 &lt;| String.concat &quot;\n&quot; xs
    | None -&gt; Choice2Of2 a
</code></pre>

<p>And <code>Validate</code> is:</p>

<pre><code class="language-fsharp">type Validate&lt;'a&gt; =
    | Object of
        value : Expr&lt;'a&gt; *
        required : bool *
        proof : ('a -&gt; (string list option) list)
    | Array of
        value : Expr&lt;'a[]&gt; *
        required : bool *
        proof : ('a[] -&gt; string Option) list *
        proveItems : ('a -&gt; Validate&lt;'a&gt;)
    | Primitive of
        value : Expr&lt;'a&gt; *
        required : bool *
        proof : ('a -&gt; string Option) list
    | Raw of
        value : 'a *
        message : string *
        proof : ('a -&gt; string Option) list
</code></pre>

<p>Other F# validation libraries (that I know of).</p>

<p><a href="http://fsharpforfunandprofit.com/posts/recipe-part2/">http://fsharpforfunandprofit.com/posts/recipe-part2/</a></p>

      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="http://jnyman.com/2016/07/10/swagger_is_too_restrictive/" data-toggle="tooltip" data-placement="top" title="Swagger is too Restrictive">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="http://jnyman.com/2016/12/04/fsharp_with_webapi/" data-toggle="tooltip" data-placement="top" title="F# with Web API and Railway-Oriented Programming">Next Post &rarr;</a>
          </li>
        
      </ul>

      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/jon49" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/NymanJon" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/eenyman" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          Jon Nyman
          &nbsp;&bull;&nbsp;
          2017

          
            &nbsp;&bull;&nbsp;
            <a href="http://jnyman.com/">JNyman.com</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.25.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="http://jnyman.com/js/main.js"></script>
<script src="http://jnyman.com/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="/js/load-photoswipe.js"></script>



  </body>
</html>

